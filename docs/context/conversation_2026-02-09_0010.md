# Context Snapshot - KasGate
**Date:** 2026-02-09 00:10
**Context Usage:** 541%

## Current Task
Fix blocked payment detection and confirmation tracking (RPC connectivity issue)

## Key Decisions Made
- Migrated from `kaspa-wasm` to `@dfns/kaspa-wasm` (working SDK)
- Added RPC fallback URLs when Resolver fails
- Made RPC initialization non-blocking (server starts without RPC)
- Fixed SQLite `datetime('now')` syntax (was using double quotes)
- Fixed xPub regex to accept `kpub` prefix (Kaspa format)

## Implementation State
- [x] Core API endpoints (merchants, sessions)
- [x] HD wallet address derivation
- [x] QR code generation
- [x] Widget JS compiled
- [x] WebSocket server initialized
- [x] Database schema and queries
- [ ] Payment detection (blocked by RPC)
- [ ] Confirmation tracking (blocked by RPC)

## Important Context
- Test xPub generated: `kpub2HxWsqx1FnuPSTEGmq9RdkuMEUCadSqpSqKkU6iRkvwEijpctLYWV8rBEZcJkzA6WGG3MZeSAj8iFPErg138ohbH4eUbrTKg6o79UJFe3oz`
- API works: create merchant → get API key → create session → get unique address
- Fallback RPC URLs added in `/src/kaspa/rpc.ts`

## Blockers / Open Questions
- Kaspa testnet-10 RPC infrastructure appears down
- Resolver and all fallback URLs timing out
- Need to verify if this is temporary or requires different endpoints

## Files Modified This Session
- `src/server/services/address.ts` - Fixed datetime syntax
- `src/server/services/merchant.ts` - Fixed datetime syntax (3 places)
- `src/server/index.ts` - Made RPC non-blocking
- `src/server/routes/merchants.ts` - Fixed xPub regex
- `src/shared/validation.ts` - Fixed xPub regex
- `scripts/generate-xpub.mjs` - New test utility

## Next Steps
1. Check RPC connectivity options
2. Consider polling-based fallback for payment detection
3. Test with mainnet endpoints if testnet unavailable
